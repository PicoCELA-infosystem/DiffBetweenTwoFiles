# Web版 CSV比較ツール 仕様書

## 1. 概要

このドキュメントは「Web版 CSV比較ツール」の技術的な仕様、設計、および開発・保守に関する情報をまとめたものです。

本ツールは、Python製のローカルスクリプトをWebアプリケーションとして再実装したもので、利用者のブラウザ上ですべての処理が完結します。ファイルが外部サーバーにアップロードされることはありません。

## 2. ファイル構成

プロジェクトは以下のファイルで構成されています。

### ルートディレクトリ

- **`index.html`**: アプリケーションのメイン画面となるUIを定義します。
- **`manual.html`**: `manual.md` からビルドされた使い方マニュアルのHTMLファイルです。
- **`style.css`**: `index.html` と `manual.html` の両方に適用されるスタイルシートです。
- **`script.js`**: アプリケーションのすべての処理ロジックを記述します。
- **`README.md`**: プロジェクトの概要とマニュアルへのリンクを記載した、開発者向けの入り口となるファイルです。

### `計画` フォルダ

- **`manual.md`**: 使い方マニュアルの原本となるMarkdownファイルです。
- **`仕様書.md`**: このファイルです。開発者向けの技術ドキュメントです。
- **`ビルド手順.md`**: MarkdownからHTMLを生成するスクリプトの使い方を説明します。
- **`build.js`**: `manual.md` をHTMLに変換するためのNode.jsビルドスクリプトです。
- **`template.html`**: HTML生成時に使用する共通の雛形ファイルです。

---

## 3. 主要な処理の流れ (`script.js`)

中核となるロジックは `script.js` に集約されています。処理は「比較実行」ボタンのクリックを起点に開始されます。

### 3.1. ファイル読み込み (`readFileAsLines` 関数)

1. `FileReader` を使用して、選択されたCSVファイルを非同期に読み込みます。
2. 読み込んだテキストデータを改行コード (`\r\n` または `\n`) で分割し、行ごとの配列に変換します。
3. **`slice(1)` を用いて、ヘッダーである先頭1行をスキップします。**
4. 各行のデータ（文字列）と、元のファイルでの行番号 (`originalIndex`) をペアにしたオブジェクトの配列 (`{line, originalIndex}`) を生成します。
5. 空行を除外して配列を返します。

### 3.2. 比較分析 (`analyzeDiffs` 関数)

この関数は、Python版スクリプトの分析ロジックを忠実に再現しています。

1. **データ構造化**:
    - まず、`createLinesMap` という内部ヘルパー関数を使い、各ファイルの行データを `Map` オブジェクトに変換します。
    - この `Map` は、行の文字列をキー、その行が出現した**すべての行番号の配列**を値として保持します (`Map<string, number[]>`)。
    - この構造により、「どの内容が」「どの行に」出現したかを重複を含めて正確に追跡できます。

2. **差分・共通・重複の特定**:
    - `Set` オブジェクトを用いて、2つのファイルの行内容（`Map`のキー）の集合演算（差集合、積集合）を行います。これにより、「Aのみ」「Bのみ」「両方に共通」の行内容を高速に特定します。
    - 各カテゴリに該当する行オブジェクトを、`Map` から取得して配列にまとめます。
    - **`in_both`** については、Python版のロジックに合わせ、共通する内容について **File Aで最初に出現した1行のみ** を収集します。
    - 各ファイル内で重複している行は、`Map` の値（行オブジェクトの配列）の長さが2以上であるものを抽出することで特定します。

3. **結果の返却**:
    - 5つのカテゴリ（`onlyInA`, `onlyInB`, `inBoth`, `duplicatesInA`, `duplicatesInB`）に分類された行オブジェクトの配列を格納した、単一の結果オブジェクトを返します。

### 3.3. 結果のZIP化とダウンロード (`downloadResultsAsZip` 関数)

1. `JSZip` ライブラリを使用して、新しいZIPファイルをメモリ上に作成します。
2. `analyzeDiffs` から受け取った結果オブジェクトを基に、`toCsv` ヘルパー関数が各カテゴリのCSVファイルを生成します。
    - `toCsv` は、各カテゴリの配列（例: `results.onlyInA`）を受け取り、行番号とデータをCSV形式の文字列に変換します。
3. 5種類の分析結果CSVと、説明用の `README.md` をZIPファイルに追加します。
4. `JSZip` で生成したZIPデータ（Blob形式）を、`FileSaver.js` の `saveAs` 関数に渡して、利用者にダウンロードを促します。

## 4. 依存ライブラリ

- **JSZip.js**: JavaScriptでZIPファイルを生成・操作するためのライブラリです。

- **FileSaver.js**: ブラウザでファイルを保存する処理を簡単にするためのライブラリです。

## 5. 開発と保守

### 5.1. マニュアルの更新

マニュアル (`manual.html`) を更新する場合は、`計画/manual.md` を編集し、`計画/ビルド手順.md` に従ってビルドスクリプトを実行します。

### 5.2. デプロイ

本プロジェクトはGitHub Pagesでホスティングされることを想定しています。
ローカルでの変更をGitでコミットし、リモートリポジトリにプッシュすることで、公開サイトが自動的に更新されます。
