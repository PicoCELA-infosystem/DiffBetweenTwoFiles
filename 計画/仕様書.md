# Web版 CSV比較ツール 仕様書

## 1. 概要

このドキュメントは「Web版 CSV比較ツール」の技術的な仕様、設計、および開発・保守に関する情報をまとめたものです。

本ツールは、Python製のローカルスクリプトをWebアプリケーションとして再実装したもので、利用者のブラウザ上ですべての処理が完結します。ファイルが外部サーバーにアップロードされることはありません。

## 2. ファイル構成

プロジェクトは以下の主要なファイルで構成されています。

- **`index.html`**
  - アプリケーションのUI（ユーザーインターフェース）を定義するHTMLファイルです。
  - ファイル選択ボタン、実行ボタン、結果表示エリアなどが配置されています。
  - 依存ライブラリ (`JSZip.js`, `FileSaver.js`) と `script.js` を読み込みます。

- **`style.css`**
  - アプリケーションの見た目を整えるためのCSSファイルです。

- **`script.js`**
  - アプリケーションのすべての処理ロジックを記述するJavaScriptファイルです。詳細は次項で説明します。

- **`README.md`**
  - このツールを利用するエンドユーザー向けの簡単な説明書です。

- **`仕様書.md`**
  - このファイルです。開発者向けの技術的なドキュメントです。

## 3. 主要な処理の流れ (`script.js`)

中核となるロジックは `script.js` に集約されています。処理は「比較実行」ボタンのクリックを起点に開始されます。

### 3.1. ファイル読み込み (`readFileAsLines` 関数)

1. `FileReader` を使用して、選択されたCSVファイルを非同期に読み込みます。
2. 読み込んだテキストデータを改行コード (`\r\n` または `\n`) で分割し、行ごとの配列に変換します。
3. **`slice(1)` を用いて、ヘッダーである先頭1行をスキップします。**
4. 各行のデータ（文字列）と、元のファイルでの行番号 (`originalIndex`) をペアにしたオブジェクトの配列 (`{line, originalIndex}`) を生成して返します。

### 3.2. 比較分析 (`analyzeDiffs` 関数)

この関数は、Python版スクリプトの分析ロジックを忠実に再現しています。

1. **データ構造化**:
    - まず、`createLinesMap` という内部ヘルパー関数を使い、各ファイルの行データを `Map` オブジェクトに変換します。
    - この `Map` は、行の文字列をキー、その行が出現した**すべての行番号の配列**を値として保持します (`Map<string, number[]>`)。
    - この構造により、「どの内容が」「どの行に」出現したかを正確に追跡できます。

2. **差分・共通・重複の特定**:
    - `Set` オブジェクトを用いて、2つのファイルの行内容（`Map`のキー）の集合演算（差集合、積集合）を行います。これにより、「Aのみ」「Bのみ」「両方に共通」の行内容を高速に特定します。
    - 各ファイル内で重複している行は、`Map` の値（行番号の配列）の長さが2以上であるものを抽出することで特定します。

3. **結果の返却**:
    - 分析結果（各カテゴリに分類された行内容のリストと、元の`Map`オブジェクト）をまとめて返します。

### 3.3. 結果のZIP化とダウンロード (`downloadResultsAsZip` 関数)

1. `JSZip` ライブラリを使用して、新しいZIPファイルをメモリ上に作成します。
2. `analyzeDiffs` から受け取った結果を基に、`toCsv` ヘルパー関数が各カテゴリのCSVファイルを生成します。
    - `toCsv` は、行内容と `Map` を参照して、該当するすべての行（行番号とデータ）をCSV形式の文字列に変換します。
3. 5種類の分析結果CSVと、説明用の `README.md` をZIPファイルに追加します。
4. `JSZip` で生成したZIPデータ（Blob形式）を、`FileSaver.js` の `saveAs` 関数に渡して、利用者にダウンロードを促します。

## 4. 依存ライブラリ

- **JSZip.js**: JavaScriptでZIPファイルを生成・操作するためのライブラリです。
  - CDN: `https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js`

- **FileSaver.js**: ブラウザでファイルを保存する処理を簡単にするためのライブラリです。
  - CDN: `https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js`

## 5. 開発とデプロイ

本プロジェクトはGitHub Pagesでホスティングされています。

1. ローカルで `index.html`, `style.css`, `script.js` などのファイルを修正します。
2. 変更内容をGitでコミットし、`main` ブランチにプッシュします。

    ```powershell
    git add .
    git commit -m "変更内容の要約"
    git push origin main
    ```

3. プッシュ後、数分でGitHub Pages上の公開サイトが自動的に更新されます。
